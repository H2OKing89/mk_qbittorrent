<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        
        .config-card {
            @apply bg-white rounded-lg shadow-sm p-6 mb-6;
        }
        
        .section-header {
            @apply text-xl font-bold text-gray-900 mb-4 flex items-center gap-2;
        }
        
        .input-group {
            @apply mb-4;
        }
        
        .label {
            @apply block text-sm font-medium text-gray-700 mb-2;
        }
        
        .input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500;
        }
        
        .checkbox-item {
            @apply flex items-center space-x-2 cursor-pointer;
        }
        
        .tab-button {
            @apply px-6 py-3 font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition-colors cursor-pointer;
        }
        
        .tab-button.active {
            @apply text-blue-600 border-blue-600;
        }
        
        .accent-blue {
            @apply bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors;
        }
        
        .accent-green {
            @apply bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors;
        }
        
        .accent-red {
            @apply bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors;
        }
        
        .status-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        
        .status-badge.success {
            @apply bg-green-100 text-green-800;
        }
        
        .status-badge.error {
            @apply bg-red-100 text-red-800;
        }
        
        .status-badge.warning {
            @apply bg-orange-100 text-orange-800;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="configManager()" x-cloak class="container mx-auto px-4 py-8">
        
        <!-- Header -->
        <div class="config-card">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">‚öôÔ∏è Configuration</h1>
                    <p class="text-gray-600 mt-1">Manage your Easy Torrent Creator settings</p>
                </div>
                <div class="flex space-x-2">
                    <button @click="saveConfig()" 
                            :disabled="isLoading"
                            class="accent-green disabled:opacity-50">
                        <i class="fas fa-save mr-2"></i>Save Configuration
                    </button>
                    <a href="/" class="accent-blue">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Home
                    </a>
                </div>
            </div>
            
            <!-- Save Status -->
            <div x-show="saveStatus" 
                 :class="saveSuccess ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'"
                 class="mt-4 border rounded-lg p-4">
                <div class="flex items-center">
                    <i :class="saveSuccess ? 'fas fa-check-circle text-green-500' : 'fas fa-exclamation-circle text-red-500'" class="mr-2"></i>
                    <span x-text="saveMessage"></span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <div @click="activeTab = 'connection'" 
                         :class="activeTab === 'connection' ? 'active' : ''"
                         class="tab-button">
                        <i class="fas fa-plug mr-2"></i>Connection
                    </div>
                    <div @click="activeTab = 'torrent'" 
                         :class="activeTab === 'torrent' ? 'active' : ''"
                         class="tab-button">
                        <i class="fas fa-cog mr-2"></i>Torrent Settings
                    </div>
                    <div @click="activeTab = 'paths'" 
                         :class="activeTab === 'paths' ? 'active' : ''"
                         class="tab-button">
                        <i class="fas fa-folder mr-2"></i>Paths & Docker
                    </div>
                    <div @click="activeTab = 'security'" 
                         :class="activeTab === 'security' ? 'active' : ''"
                         class="tab-button">
                        <i class="fas fa-shield-alt mr-2"></i>Security
                    </div>
                    <div @click="activeTab = 'advanced'" 
                         :class="activeTab === 'advanced' ? 'active' : ''"
                         class="tab-button">
                        <i class="fas fa-tools mr-2"></i>Advanced
                    </div>
                </nav>
            </div>
        </div>
        
        <!-- Connection Tab -->
        <div x-show="activeTab === 'connection'" class="space-y-6">
            <div class="config-card">
                <h2 class="section-header">üîå qBittorrent Connection</h2>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="input-group">
                        <label class="label">Host</label>
                        <input x-model="config.qbittorrent.host" type="text" class="input" placeholder="localhost">
                    </div>
                    <div class="input-group">
                        <label class="label">Port</label>
                        <input x-model="config.qbittorrent.port" type="number" class="input" placeholder="8080">
                    </div>
                    <div class="input-group">
                        <label class="label">Use HTTPS</label>
                        <label class="checkbox-item mt-2">
                            <input x-model="config.qbittorrent.use_https" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span>Secure (https://)</span>
                        </label>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="input-group">
                        <label class="label">Base Path (optional)</label>
                        <input x-model="config.qbittorrent.base_path" type="text" class="input" placeholder="/qb">
                        <p class="text-xs text-gray-500 mt-1">For reverse proxy setups</p>
                    </div>
                    <div class="input-group">
                        <label class="label">Verify TLS</label>
                        <label class="checkbox-item mt-2">
                            <input x-model="config.qbittorrent.verify_tls" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span>Validate certificates</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Disable for self-signed certs</p>
                    </div>
                </div>
                
                <!-- Authentication Mode -->
                <div class="input-group">
                    <label class="label">Authentication Mode</label>
                    <div class="flex gap-3">
                        <label class="checkbox-item">
                            <input x-model="config.qbittorrent.auth_mode" type="radio" value="secret">
                            <span class="font-medium">üîí Use Secure Store</span>
                        </label>
                        <label class="checkbox-item">
                            <input x-model="config.qbittorrent.auth_mode" type="radio" value="plain">
                            <span class="font-medium">‚úçÔ∏è Provide Plain Credentials</span>
                        </label>
                    </div>
                </div>

                <!-- Secret mode -->
                <div x-show="config.qbittorrent.auth_mode === 'secret'" class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="label">Username Secret Key</label>
                        <div class="relative">
                            <input x-model="config.qbittorrent.username_ref" type="text" class="input pr-28" placeholder="QBIT_USERNAME">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs">
                                <span x-show="credentialDetails[config.qbittorrent.username_ref]?.exists" class="status-badge success">üîí Stored</span>
                                <span x-show="!credentialDetails[config.qbittorrent.username_ref]?.exists" class="status-badge warning">üìù Missing</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">Name of the secret key storing your qBittorrent username</p>
                    </div>

                    <div class="input-group">
                        <label class="label">Password Secret Key</label>
                        <div class="relative">
                            <input x-model="config.qbittorrent.password_ref" type="text" class="input pr-28" placeholder="QBIT_PASSWORD">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs">
                                <span x-show="credentialDetails[config.qbittorrent.password_ref]?.exists" class="status-badge success">üîí Stored</span>
                                <span x-show="!credentialDetails[config.qbittorrent.password_ref]?.exists" class="status-badge warning">üìù Missing</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500">Name of the secret key storing your qBittorrent password</p>
                    </div>
                </div>

                <!-- Plain mode -->
                <div x-show="config.qbittorrent.auth_mode === 'plain'" class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="label">Username (Plain)</label>
                        <input x-model="config.qbittorrent.username" type="text" class="input" placeholder="admin">
                        <p class="text-xs text-gray-500">Stored in config (not recommended)</p>
                    </div>
                    <div class="input-group">
                        <label class="label">Password (Plain)</label>
                        <input x-model="config.qbittorrent.password" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <p class="text-xs text-gray-500">Stored in config (not recommended)</p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-6">
                    <button @click="testConnection()" 
                            :disabled="isLoading"
                            class="accent-blue disabled:opacity-50">
                        <i class="fas fa-plug mr-2"></i>Test Connection
                    </button>
                    
                    <!-- Connection Status -->
                    <div x-show="connectionStatus" class="flex items-center space-x-2">
                        <div :class="connectionSuccess ? 'bg-green-500' : 'bg-red-500'" class="w-3 h-3 rounded-full"></div>
                        <span :class="connectionSuccess ? 'text-green-700' : 'text-red-700'" 
                              class="font-medium" x-text="connectionMessage"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Torrent Settings Tab -->
        <div x-show="activeTab === 'torrent'" class="space-y-6">
            <div class="config-card">
                <h2 class="section-header">üîß Torrent Creation Settings</h2>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="input-group">
                        <label class="label">Torrent Format</label>
                        <select x-model="config.torrent_creation.format" class="input">
                            <option value="v1">v1 (Classic)</option>
                            <option value="v2">v2 (Modern)</option>
                            <option value="hybrid">Hybrid (Both)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="label">Piece Size (bytes)</label>
                        <input x-model="config.torrent_creation.piece_size" type="number" class="input" placeholder="Auto">
                        <p class="text-xs text-gray-500">Leave empty for automatic</p>
                    </div>
                    <div class="input-group">
                        <label class="label">Creation Timeout (seconds)</label>
                        <input x-model="config.torrent_creation.timeout" type="number" class="input" placeholder="300">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="label">Comment</label>
                        <input x-model="config.torrent_creation.comment" type="text" class="input" placeholder="Created with Easy Torrent Creator">
                    </div>
                    <div class="input-group">
                        <label class="label">Poll Interval (seconds)</label>
                        <input x-model="config.torrent_creation.poll_interval" type="number" step="0.1" class="input" placeholder="1.0">
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.torrent_creation.private" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Private Torrent</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Enable for private trackers</p>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.torrent_creation.start_seeding" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Auto Start Seeding</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Begin seeding immediately</p>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.torrent_creation.optimize_alignment" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Optimize Alignment</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Align file boundaries</p>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h2 class="section-header">üè∑Ô∏è qBittorrent Management</h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="label">Category</label>
                        <input x-model="config.qbittorrent.category" type="text" class="input" placeholder="upload.audiobooks">
                    </div>
                    <div class="input-group">
                        <label class="label">Save Path</label>
                        <input x-model="config.qbittorrent.save_path"
                               :disabled="config.qbittorrent.auto_torrent_management"
                               class="input"
                               placeholder="/data/downloads/torrents/qbittorrent/seedvault/audiobooks">
                        <p class="text-xs text-gray-500">
                            <span x-show="config.qbittorrent.auto_torrent_management">qBittorrent will use the category root path (Auto Management is ON).</span>
                            <span x-show="!config.qbittorrent.auto_torrent_management">Explicit save path will be used.</span>
                        </p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="label">Tags</label>
                    <input x-model="tagsInput" type="text" class="input" placeholder="Uploaded:H2OKing, MyTag">
                    <p class="text-xs text-gray-500">Comma-separated tags. Max length: <span x-text="config.qbittorrent.max_tag_length"></span> characters per tag</p>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.qbittorrent.auto_add_after_creation" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Auto Add to qBittorrent</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.qbittorrent.auto_torrent_management" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Auto Torrent Management</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label class="label">Max Tag Length</label>
                        <input x-model="config.qbittorrent.max_tag_length" type="number" class="input" placeholder="50">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Security Tab -->
        <div x-show="activeTab === 'security'" class="space-y-6">
            <div class="config-card">
                <h2 class="section-header">üîê qBittorrent Credentials (Secure Store)</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="label">Username</label>
                        <input x-model="newQbitCredential.username" type="text" class="input" placeholder="admin">
                    </div>
                    <div class="input-group">
                        <label class="label">Password</label>
                        <input x-model="newQbitCredential.password" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <div class="flex justify-end mt-3">
                    <button @click="storeQbitCredentials()" class="accent-green">
                        üîí Store as QBIT_USERNAME / QBIT_PASSWORD
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">These are saved under secret keys and referenced by the Connection tab.</p>
            </div>
            
            <div class="config-card">
                <h2 class="section-header">üõ°Ô∏è Secure Tracker Management</h2>
                
                <div class="grid grid-cols-1 gap-4">
                    <div class="input-group">
                        <label class="label">Tracker URL</label>
                        <input x-model="newTrackerCredential.value" type="text" class="input" 
                               placeholder="https://tracker.example.com/announce?passkey=your_passkey_here">
                        <p class="text-xs text-gray-500">Full tracker announce URL with passkey</p>
                    </div>
                    <div class="input-group">
                        <label class="label">Custom Name (optional)</label>
                        <input x-model="newTrackerCredential.customName" type="text" class="input" 
                               placeholder="My Private Tracker">
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button @click="storeTrackerCredential()" class="accent-green">
                        üîí Store Tracker Securely
                    </button>
                </div>
                
                <!-- Stored Trackers -->
                <div x-show="credentialDetails.TRACKER?.exists" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-2">Stored Tracker</h4>
                    <div class="text-sm text-gray-600">
                        <div><strong>Name:</strong> <span x-text="credentialDetails.TRACKER?.custom_name || 'Default Tracker'"></span></div>
                        <div><strong>URL:</strong> <code class="bg-gray-200 px-2 py-1 rounded" x-text="credentialDetails.TRACKER?.masked_value"></code></div>
                    </div>
                    <button @click="deleteCredential('TRACKER')" class="accent-red text-sm mt-2">
                        üóëÔ∏è Remove Tracker
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Advanced Tab -->
        <div x-show="activeTab === 'advanced'" class="space-y-6">
            <div class="config-card">
                <h2 class="section-header">üõ†Ô∏è Debug & Logging</h2>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="input-group">
                        <label class="label">Log Level</label>
                        <select x-model="config.debug.log_level" class="input">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.debug.api_debug" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">API Debug Logging</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.debug.metrics" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Performance Metrics</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h2 class="section-header">üìÅ Application Settings</h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="label">Default Output Directory</label>
                        <input x-model="config.default_output_dir" type="text" class="input" placeholder="./torrents">
                    </div>
                    <div class="input-group">
                        <label class="label">Default Upload Root</label>
                        <input x-model="config.default_upload_root" type="text" class="input" 
                               placeholder="/mnt/user/data/downloads/torrents/qbittorrent/seedvault/">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.remember_last_folder" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Remember Last Folder</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-item">
                            <input x-model="config.auto_open_output_folder" type="checkbox" class="rounded border-gray-300 text-blue-600">
                            <span class="font-medium">Auto Open Output Folder</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="config-card">
                <h2 class="section-header">üì§ Configuration Management</h2>
                
                <div class="flex space-x-4">
                    <button @click="exportConfig()" class="accent-blue">
                        üì§ Export Config
                    </button>
                    
                    <input type="file" accept=".yaml,.yml,.json" class="hidden" id="config-import" @change="importConfig($event)">
                    <label for="config-import" class="accent-green cursor-pointer inline-flex items-center px-4 py-2 rounded-lg">
                        üì• Import Config
                    </label>
                    
                    <button @click="resetToDefaults()" class="accent-red">
                        üîÑ Reset to Defaults
                    </button>
                </div>
                
                <p class="text-xs text-gray-500 mt-2">Export/import configuration files for backup or sharing between installations.</p>
            </div>
        </div>
        
        <!-- Paths & Docker Tab -->
        <div x-show="activeTab === 'paths'" class="space-y-6">
            <div class="config-card">
                <h2 class="section-header">üê≥ Docker Path Mappings</h2>
                
                <div class="mb-4">
                    <label class="checkbox-item">
                        <input x-model="config.docker_mapping.enabled" type="checkbox" class="rounded border-gray-300 text-blue-600">
                        <span class="font-medium">Enable Docker Path Mapping</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">Map host paths to container paths for qBittorrent running in Docker</p>
                </div>
                
                <div x-show="config.docker_mapping.enabled" class="space-y-4">
                    <!-- Existing mappings -->
                    <template x-for="(mapping, index) in dockerMappings" :key="index">
                        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <input x-model="mapping.host" type="text" class="input" placeholder="Host path (e.g., /mnt/user/data)">
                            </div>
                            <div class="text-gray-500">‚Üí</div>
                            <div class="flex-1">
                                <input x-model="mapping.container" type="text" class="input" placeholder="Container path (e.g., /data)">
                            </div>
                            <button @click="dockerMappings.splice(index, 1)" class="accent-red text-sm">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </template>
                    
                    <!-- Add new mapping -->
                    <div class="flex items-center gap-4 p-4 border-2 border-dashed border-gray-300 rounded-lg">
                        <div class="flex-1">
                            <input x-model="newMapping.host" type="text" class="input" placeholder="Host path">
                        </div>
                        <div class="text-gray-500">‚Üí</div>
                        <div class="flex-1">
                            <input x-model="newMapping.container" type="text" class="input" placeholder="Container path">
                        </div>
                        <button @click="addDockerMapping()" class="accent-green text-sm">
                            ‚ûï Add Mapping
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        function configManager() {
            return {
                // UI State
                activeTab: 'connection',
                isLoading: false,
                saveStatus: null,
                saveSuccess: false,
                saveMessage: '',
                connectionStatus: null,
                connectionSuccess: false,
                connectionMessage: '',
                
                // Credentials
                credentialStatus: {},
                credentialDetails: {},
                newTrackerCredential: { value: '', customName: '' },
                newQbitCredential: { username: '', password: '' },
                
                // Docker mappings
                dockerMappings: [],
                newMapping: { host: '', container: '' },
                
                // Form helpers
                tagsInput: '',
                
                // Configuration (with proper defaults)
                config: {
                    qbittorrent: {
                        host: 'localhost',
                        port: 8080,
                        auth_mode: 'secret',
                        username_ref: 'QBIT_USERNAME',
                        password_ref: 'QBIT_PASSWORD',
                        username: '',
                        password: '',
                        use_https: false,
                        base_path: '',
                        verify_tls: true,
                        category: 'upload.audiobooks',
                        save_path: '/data/downloads/torrents/qbittorrent/seedvault/audiobooks',
                        auto_add_after_creation: true,
                        auto_torrent_management: true,
                        connection_timeout: 10.0,
                        read_timeout: 30.0,
                        tags: [],
                        trackers: ['${TRACKER}'],
                        docker_path_mapping: {},
                        max_tag_length: 50
                    },
                    torrent_creation: {
                        format: 'v1',
                        private: true,
                        start_seeding: true,
                        comment: 'Created with Easy Torrent Creator',
                        piece_size: null,
                        optimize_alignment: true,
                        padded_file_size_limit: null,
                        timeout: 300,
                        poll_interval: 1.0
                    },
                    web_server: {
                        host: '0.0.0.0',
                        port: 8094,
                        reload: true
                    },
                    default_output_dir: './torrents',
                    default_upload_root: '/mnt/user/data/downloads/torrents/qbittorrent/seedvault/',
                    remember_last_folder: true,
                    auto_open_output_folder: true,
                    docker_mapping: {
                        enabled: true,
                        mappings: {}
                    },
                    debug: {
                        log_level: 'INFO',
                        api_debug: false,
                        metrics: false
                    }
                },
                
                // Initialization
                async init() {
                    await this.loadConfig();
                    await this.loadCredentialStatus();
                    await this.loadCredentialDetails();
                    this.initDockerMappings();
                    this.initTagsInput();
                },
                
                // Deep merge utility
                deepMerge(target, source) {
                    for (const k of Object.keys(source || {})) {
                        if (source[k] && typeof source[k] === 'object' && !Array.isArray(source[k])) {
                            if (!target[k] || typeof target[k] !== 'object') target[k] = {};
                            this.deepMerge(target[k], source[k]);
                        } else {
                            target[k] = source[k];
                        }
                    }
                    return target;
                },
                
                // Configuration loading
                async loadConfig() {
                    this.isLoading = true;
                    try {
                        const response = await fetch('/api/config');
                        const loadedConfig = await response.json();
                        console.log('Loaded config:', loadedConfig);
                        this.deepMerge(this.config, loadedConfig);
                        console.log('Merged config:', this.config);
                    } catch (e) {
                        console.error('Failed to load config:', e);
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // Tags handling
                initTagsInput() {
                    this.tagsInput = (this.config.qbittorrent.tags || []).join(', ');
                },
                
                enforceTagRules(tags, maxLen) {
                    const seen = new Set();
                    const cleaned = [];
                    for (let t of (tags || [])) {
                        t = t.trim();
                        if (!t) continue;
                        // qb tags are fairly permissive but avoid commas/newlines
                        t = t.replace(/[\n\r,]/g, ' ');
                        if (maxLen && t.length > maxLen) t = t.slice(0, maxLen);
                        if (!seen.has(t)) { seen.add(t); cleaned.push(t); }
                    }
                    return cleaned;
                },
                
                // Docker mappings
                initDockerMappings() {
                    this.dockerMappings = Object.entries(this.config.docker_mapping.mappings || {}).map(([host, container]) => ({
                        host, container
                    }));
                },
                
                addDockerMapping() {
                    if (this.newMapping.host && this.newMapping.container) {
                        this.dockerMappings.push({ ...this.newMapping });
                        this.newMapping = { host: '', container: '' };
                    }
                },
                
                normalizeMappings(list) {
                    const out = {};
                    for (const {host, container} of (list || [])) {
                        if (!host || !container) continue;
                        const h = host.replace(/\/+$/,'');       // strip trailing slash
                        const c = container.replace(/\/+$/,'');
                        out[h] = c;
                    }
                    return out;
                },
                
                // Credential management
                async loadCredentialStatus() {
                    try {
                        const response = await fetch('/api/credentials/status');
                        this.credentialStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load credential status:', error);
                        this.credentialStatus = {
                            'TRACKER': false,
                            'QBIT_USERNAME': false,
                            'QBIT_PASSWORD': false
                        };
                    }
                },
                
                async loadCredentialDetails() {
                    try {
                        const response = await fetch('/api/credentials/details');
                        const details = await response.json();
                        
                        this.credentialDetails = {};
                        for (const [key, info] of Object.entries(details)) {
                            this.credentialDetails[key] = {
                                exists: info.exists,
                                customName: info.custom_name || '',
                                maskedValue: info.masked_value || ''
                            };
                        }
                    } catch (error) {
                        console.error('Failed to load credential details:', error);
                        this.credentialDetails = {};
                        for (const [key, exists] of Object.entries(this.credentialStatus)) {
                            this.credentialDetails[key] = {
                                exists: exists,
                                customName: '',
                                maskedValue: ''
                            };
                        }
                    }
                },
                
                async storeQbitCredentials() {
                    if (!this.newQbitCredential.username || !this.newQbitCredential.password) {
                        return alert('Please provide both username and password');
                    }
                    try {
                        const reqs = [
                            fetch('/api/credentials', { 
                                method:'POST', 
                                headers:{'Content-Type':'application/json'}, 
                                body: JSON.stringify({ 
                                    key:'QBIT_USERNAME', 
                                    value:this.newQbitCredential.username 
                                }) 
                            }),
                            fetch('/api/credentials', { 
                                method:'POST', 
                                headers:{'Content-Type':'application/json'}, 
                                body: JSON.stringify({ 
                                    key:'QBIT_PASSWORD', 
                                    value:this.newQbitCredential.password 
                                }) 
                            }),
                        ];
                        const [uRes, pRes] = await Promise.all(reqs);
                        const [u, p] = await Promise.all([uRes.json(), pRes.json()]);
                        if (u.success && p.success) {
                            alert('‚úÖ Stored qBittorrent credentials securely');
                            this.newQbitCredential = { username:'', password:'' };
                            await this.loadCredentialStatus();
                            await this.loadCredentialDetails();
                        } else {
                            alert(`‚ùå Failed: ${u.message || ''} ${p.message || ''}`);
                        }
                    } catch (e) {
                        alert(`‚ùå Error storing qBittorrent credentials: ${e.message}`);
                    }
                },
                
                async storeTrackerCredential() {
                    if (!this.newTrackerCredential.value) {
                        return alert('Please provide a tracker URL');
                    }
                    try {
                        const response = await fetch('/api/credentials', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                key: 'TRACKER',
                                value: this.newTrackerCredential.value,
                                customName: this.newTrackerCredential.customName
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            alert('‚úÖ Tracker stored securely');
                            this.newTrackerCredential = { value: '', customName: '' };
                            await this.loadCredentialStatus();
                            await this.loadCredentialDetails();
                        } else {
                            alert(`‚ùå ${result.message}`);
                        }
                    } catch (e) {
                        alert(`‚ùå Error storing tracker: ${e.message}`);
                    }
                },
                
                async deleteCredential(key) {
                    if (!confirm(`Are you sure you want to delete the ${key} credential?`)) return;
                    try {
                        const response = await fetch('/api/credentials', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key })
                        });
                        const result = await response.json();
                        if (result.success) {
                            alert('‚úÖ Credential deleted');
                            await this.loadCredentialStatus();
                            await this.loadCredentialDetails();
                        } else {
                            alert(`‚ùå ${result.message}`);
                        }
                    } catch (e) {
                        alert(`‚ùå Error deleting credential: ${e.message}`);
                    }
                },
                
                // Configuration updating
                updateConfigFromUI() {
                    // docker mappings
                    this.config.docker_mapping.mappings = this.normalizeMappings(this.dockerMappings);

                    // tags
                    const raw = this.tagsInput ? this.tagsInput.split(',') : [];
                    this.config.qbittorrent.tags = this.enforceTagRules(raw, Number(this.config.qbittorrent.max_tag_length) || 0);

                    // strong typing
                    this.config.qbittorrent.port = Number(this.config.qbittorrent.port);
                    this.config.qbittorrent.connection_timeout = Number(this.config.qbittorrent.connection_timeout);
                    this.config.qbittorrent.read_timeout = Number(this.config.qbittorrent.read_timeout);
                    this.config.torrent_creation.timeout = Number(this.config.torrent_creation.timeout);
                    this.config.torrent_creation.poll_interval = Number(this.config.torrent_creation.poll_interval);
                    if (this.config.torrent_creation.piece_size === '') this.config.torrent_creation.piece_size = null;
                    if (this.config.torrent_creation.padded_file_size_limit === '' || this.config.torrent_creation.padded_file_size_limit === null) {
                        this.config.torrent_creation.padded_file_size_limit = null;
                    } else {
                        this.config.torrent_creation.padded_file_size_limit = Number(this.config.torrent_creation.padded_file_size_limit);
                    }
                },
                
                serializeForBackend() {
                    const cfg = JSON.parse(JSON.stringify(this.config));
                    // Build explicit auth block to remove ambiguity
                    cfg.qbittorrent.auth = {
                        mode: cfg.qbittorrent.auth_mode, // 'secret' | 'plain'
                        username_ref: cfg.qbittorrent.username_ref || null,
                        password_ref: cfg.qbittorrent.password_ref || null,
                        username: cfg.qbittorrent.auth_mode === 'plain' ? (cfg.qbittorrent.username || '') : null,
                        password: cfg.qbittorrent.auth_mode === 'plain' ? (cfg.qbittorrent.password || '') : null,
                    };
                    // Optional: strip plain fields when secret mode
                    if (cfg.qbittorrent.auth_mode === 'secret') {
                        delete cfg.qbittorrent.username;
                        delete cfg.qbittorrent.password;
                    }
                    return cfg;
                },
                
                // Actions
                async saveConfig() {
                    this.isLoading = true; 
                    this.saveStatus = null;
                    try {
                        this.updateConfigFromUI();
                        const payload = this.serializeForBackend();
                        console.log('Saving config:', payload);
                        const response = await fetch('/api/save-config', {
                            method:'POST', 
                            headers:{'Content-Type':'application/json'}, 
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        this.saveSuccess = result.success;
                        this.saveMessage = result.message || (result.success ? 'Configuration saved successfully!' : 'Failed to save configuration');
                    } catch (e) {
                        this.saveSuccess = false; 
                        this.saveMessage = `Save failed: ${e.message}`;
                    } finally {
                        this.saveStatus = true; 
                        this.isLoading = false;
                        setTimeout(()=>{ this.saveStatus = null; }, 8000);
                    }
                },

                async testConnection() {
                    this.isLoading = true; 
                    this.connectionStatus = null;
                    try {
                        this.updateConfigFromUI();
                        const payload = this.serializeForBackend();
                        console.log('Testing connection with config:', payload);
                        const res = await fetch('/api/test-connection', {
                            method:'POST', 
                            headers:{'Content-Type':'application/json'}, 
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        this.connectionSuccess = data.success;
                        this.connectionMessage = data.message;
                    } catch (e) {
                        this.connectionSuccess = false;
                        this.connectionMessage = `Connection failed: ${e.message}`;
                    } finally {
                        this.connectionStatus = true; 
                        this.isLoading = false;
                        setTimeout(()=>{ this.connectionStatus = null; }, 8000);
                    }
                },
                
                // Configuration management
                async exportConfig() {
                    this.updateConfigFromUI();
                    const payload = this.serializeForBackend();
                    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; 
                    a.download = 'easy-torrent-config.json'; 
                    a.click();
                    URL.revokeObjectURL(url);
                },

                async importConfig(evt) {
                    const file = evt.target.files?.[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const obj = JSON.parse(text);
                        this.deepMerge(this.config, obj);
                        this.initDockerMappings();
                        this.initTagsInput();
                        alert('‚úÖ Configuration imported (not yet saved)');
                    } catch (e) {
                        alert(`‚ùå Import failed: ${e.message}`);
                    } finally {
                        evt.target.value = '';
                    }
                },
                
                async resetToDefaults() {
                    if (!confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) return;
                    // Reset to initial defaults
                    this.config = {
                        qbittorrent: {
                            host: 'localhost',
                            port: 8080,
                            auth_mode: 'secret',
                            username_ref: 'QBIT_USERNAME',
                            password_ref: 'QBIT_PASSWORD',
                            username: '',
                            password: '',
                            use_https: false,
                            base_path: '',
                            verify_tls: true,
                            category: 'upload.audiobooks',
                            save_path: '/data/downloads/torrents/qbittorrent/seedvault/audiobooks',
                            auto_add_after_creation: true,
                            auto_torrent_management: true,
                            connection_timeout: 10.0,
                            read_timeout: 30.0,
                            tags: [],
                            trackers: ['${TRACKER}'],
                            docker_path_mapping: {},
                            max_tag_length: 50
                        },
                        torrent_creation: {
                            format: 'v1',
                            private: true,
                            start_seeding: true,
                            comment: 'Created with Easy Torrent Creator',
                            piece_size: null,
                            optimize_alignment: true,
                            padded_file_size_limit: null,
                            timeout: 300,
                            poll_interval: 1.0
                        },
                        web_server: {
                            host: '0.0.0.0',
                            port: 8094,
                            reload: true
                        },
                        default_output_dir: './torrents',
                        default_upload_root: '/mnt/user/data/downloads/torrents/qbittorrent/seedvault/',
                        remember_last_folder: true,
                        auto_open_output_folder: true,
                        docker_mapping: {
                            enabled: true,
                            mappings: {}
                        },
                        debug: {
                            log_level: 'INFO',
                            api_debug: false,
                            metrics: false
                        }
                    };
                    this.initDockerMappings();
                    this.initTagsInput();
                    alert('‚úÖ Configuration reset to defaults (not yet saved)');
                }
            }
        }
    </script>
</body>
</html>
