{% extends "layouts/app.html" %}

{% block title %}ðŸ”§ Torrent Creator - qBittorrent Professional{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8" 
     x-data="torrentCreator" 
     x-init="init()">
     
    <!-- Progress Banner (when creating) -->
    <div x-show="progress.isCreating" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform -translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="mb-6">
        <div class="qbit-card">
            <div class="qbit-card-body">
                <div class="flex items-center gap-4">
                    <div class="qbit-spinner w-6 h-6 text-qbit-accent"></div>
                    <div class="flex-1">
                        <h3 class="font-medium text-qbit-text-primary">Creating Torrent...</h3>
                        <p class="text-sm text-qbit-text-muted" x-text="progress.phase || 'Initializing...'"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-semibold text-qbit-accent" x-text="progress.percentage + '%'"></div>
                        <div class="text-xs text-qbit-text-muted">Progress</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="qbit-progress">
                        <div class="qbit-progress-bar" 
                             :style="`width: ${progress.percentage}%`"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="space-y-6">
        
        <!-- Path Selection Card -->
        <div class="qbit-card">
            <div class="qbit-card-header">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 text-qbit-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"/>
                    </svg>
                    1. Source Selection
                </h2>
                <p class="text-sm text-qbit-text-muted">
                    Select the file or directory to create a torrent from
                </p>
            </div>
            <div class="qbit-card-body space-y-4">
                <!-- Path Input -->
                <div>
                    <label for="path" class="block text-sm font-medium text-qbit-text-secondary mb-2">
                        Server Path *
                    </label>
                    <input type="text" 
                           id="path"
                           class="qbit-input"
                           placeholder="/data/downloads/my-content"
                           x-model="form.path"
                           @input.debounce.500ms="onPathChange()"
                           :class="{ 'border-qbit-error focus:ring-qbit-error': !pathData.isValid && form.path }"
                           required>
                    
                    <!-- Path Validation Status -->
                    <div class="mt-2 flex items-center gap-2" x-show="form.path">
                        <template x-if="pathData.isScanning">
                            <div class="flex items-center gap-2 text-qbit-accent">
                                <div class="qbit-spinner w-4 h-4"></div>
                                <span class="text-sm">Scanning path...</span>
                            </div>
                        </template>
                        
                        <template x-if="!pathData.isScanning && pathData.isValid">
                            <div class="flex items-center gap-2 text-qbit-success">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm">Path validated</span>
                            </div>
                        </template>
                        
                        <template x-if="!pathData.isScanning && pathData.error">
                            <div class="flex items-center gap-2 text-qbit-error">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm" x-text="pathData.error"></span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Path Info (when valid) -->
                <div x-show="pathData.isValid && pathData.totalSize > 0" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform -translate-y-2"
                     x-transition:enter-end="opacity-100 transform translate-y-0"
                     class="grid grid-cols-3 gap-4 p-4 bg-qbit-bg-tertiary rounded-lg">
                    <div class="text-center">
                        <div class="text-lg font-semibold text-qbit-accent" x-text="formattedPathSize"></div>
                        <div class="text-xs text-qbit-text-muted">Total Size</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-semibold text-qbit-accent" x-text="pathData.fileCount"></div>
                        <div class="text-xs text-qbit-text-muted">Files</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-semibold text-qbit-accent" x-text="pathData.directoryCount"></div>
                        <div class="text-xs text-qbit-text-muted">Directories</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Piece Size Configuration Card -->
        <div class="qbit-card" x-show="pathData.isValid">
            <div class="qbit-card-header">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 text-qbit-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    2. Piece Size Settings
                </h2>
                <p class="text-sm text-qbit-text-muted">
                    Configure the torrent piece size for optimal performance
                </p>
            </div>
            <div class="qbit-card-body space-y-4">
                <!-- Piece Size Mode -->
                <div>
                    <label class="block text-sm font-medium text-qbit-text-secondary mb-3">
                        Piece Size Mode
                    </label>
                    <div class="qbit-btn-group">
                        <button type="button" 
                                class="qbit-btn"
                                :class="form.pieceSizeMode === 'auto' ? 'qbit-btn-primary' : 'qbit-btn-secondary'"
                                @click="form.pieceSizeMode = 'auto'; onPieceSizeModeChange()">
                            Auto (Recommended)
                        </button>
                        <button type="button" 
                                class="qbit-btn"
                                :class="form.pieceSizeMode === 'manual' ? 'qbit-btn-primary' : 'qbit-btn-secondary'"
                                @click="form.pieceSizeMode = 'manual'; onPieceSizeModeChange()">
                            Manual
                        </button>
                    </div>
                </div>
                
                <!-- Manual Piece Size Selection -->
                <div x-show="form.pieceSizeMode === 'manual'" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform -translate-y-2"
                     x-transition:enter-end="opacity-100 transform translate-y-0">
                    <label for="pieceSize" class="block text-sm font-medium text-qbit-text-secondary mb-2">
                        Piece Size
                    </label>
                    <select id="pieceSize" 
                            class="qbit-select"
                            x-model.number="form.pieceSizeBytes"
                            @change="onManualPieceSizeChange()">
                        <template x-for="option in pieceData.options" :key="option.value">
                            <option :value="option.value" x-text="option.label"></option>
                        </template>
                    </select>
                </div>
                
                <!-- Piece Calculation Results -->
                <div x-show="pieceData.recommendedSize > 0" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform -translate-y-2"
                     x-transition:enter-end="opacity-100 transform translate-y-0"
                     class="grid grid-cols-3 gap-4 p-4 bg-qbit-bg-tertiary rounded-lg">
                    <div class="text-center">
                        <div class="text-lg font-semibold text-qbit-accent" x-text="formattedPieceSize"></div>
                        <div class="text-xs text-qbit-text-muted">Piece Size</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-semibold text-qbit-accent" x-text="pieceData.pieceCount"></div>
                        <div class="text-xs text-qbit-text-muted">Total Pieces</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-semibold" :class="efficiencyColor" x-text="pieceData.efficiency.toFixed(1) + '%'"></div>
                        <div class="text-xs text-qbit-text-muted">Efficiency</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tracker Configuration Card -->
        <div class="qbit-card">
            <div class="qbit-card-header">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 text-qbit-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"/>
                    </svg>
                    3. Tracker Configuration
                </h2>
                <p class="text-sm text-qbit-text-muted">
                    Add tracker URLs to help peers find each other (one per line, empty line for new tier)
                </p>
            </div>
            <div class="qbit-card-body space-y-4">
                <!-- Tracker URLs -->
                <div>
                    <label for="trackers" class="block text-sm font-medium text-qbit-text-secondary mb-2">
                        Tracker URLs *
                    </label>
                    <textarea id="trackers" 
                              class="qbit-textarea"
                              rows="6"
                              placeholder="http://tracker.example.com:8080/announce&#10;udp://tracker.example.com:8080/announce&#10;&#10;http://backup-tracker.example.com:8080/announce"
                              x-model="form.trackerUrls"
                              @input.debounce.300ms="onTrackerChange()"
                              :class="{ 'border-qbit-error focus:ring-qbit-error': !trackerData.isValid && form.trackerUrls }"
                              required></textarea>
                    
                    <!-- Tracker Validation Status -->
                    <div class="mt-2" x-show="form.trackerUrls">
                        <template x-if="trackerData.isValidating">
                            <div class="flex items-center gap-2 text-qbit-accent">
                                <div class="qbit-spinner w-4 h-4"></div>
                                <span class="text-sm">Validating trackers...</span>
                            </div>
                        </template>
                        
                        <template x-if="!trackerData.isValidating && trackerData.isValid">
                            <div class="flex items-center gap-2 text-qbit-success">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-sm">
                                    <span x-text="trackerData.trackerCount"></span> trackers in 
                                    <span x-text="trackerData.tiers.length"></span> tier(s)
                                </span>
                            </div>
                        </template>
                        
                        <template x-if="!trackerData.isValidating && trackerData.errors.length > 0">
                            <div class="space-y-2">
                                <template x-for="error in trackerData.errors" :key="error">
                                    <div class="flex items-center gap-2 text-qbit-error">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-sm" x-text="error"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Card (Collapsible) -->
        <div class="qbit-card">
            <div class="qbit-card-header cursor-pointer" @click="ui.showAdvanced = !ui.showAdvanced">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 text-qbit-accent transition-transform duration-200"
                         :class="{ 'transform rotate-90': ui.showAdvanced }"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    4. Advanced Settings
                </h2>
                <p class="text-sm text-qbit-text-muted">
                    Optional settings for advanced torrent configuration
                </p>
            </div>
            <div x-show="ui.showAdvanced" 
                 x-collapse
                 class="qbit-card-body space-y-4">
                
                <!-- Privacy Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="font-medium text-qbit-text-primary">Privacy & Seeding</h3>
                        
                        <label class="flex items-center gap-3">
                            <input type="checkbox" 
                                   class="qbit-checkbox"
                                   x-model="form.privateTorrent"
                                   @change="onPrivateToggle()">
                            <div>
                                <div class="text-sm font-medium text-qbit-text-primary">Private Torrent</div>
                                <div class="text-xs text-qbit-text-muted">Only allow peers from tracker</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center gap-3">
                            <input type="checkbox" 
                                   class="qbit-checkbox"
                                   x-model="form.startSeeding">
                            <div>
                                <div class="text-sm font-medium text-qbit-text-primary">Start Seeding</div>
                                <div class="text-xs text-qbit-text-muted">Begin seeding after creation</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <h3 class="font-medium text-qbit-text-primary">Metadata</h3>
                        
                        <div>
                            <label for="source" class="block text-sm font-medium text-qbit-text-secondary mb-2">
                                Source (for cross-seeding)
                            </label>
                            <input type="text" 
                                   id="source"
                                   class="qbit-input"
                                   placeholder="MyTracker"
                                   x-model="form.source">
                        </div>
                        
                        <div>
                            <label for="comment" class="block text-sm font-medium text-qbit-text-secondary mb-2">
                                Comment
                            </label>
                            <input type="text" 
                                   id="comment"
                                   class="qbit-input"
                                   placeholder="Created with qBittorrent"
                                   x-model="form.comment">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center pt-6">
            <div class="flex gap-3">
                <button type="button" 
                        class="qbit-btn qbit-btn-secondary"
                        @click="clearForm()"
                        :disabled="progress.isCreating">
                    Clear Form
                </button>
            </div>
            
            <div class="flex gap-3">
                <button type="button" 
                        class="qbit-btn qbit-btn-primary"
                        @click="createTorrent()"
                        :disabled="!canCreate"
                        :class="{ 'opacity-50 cursor-not-allowed': !canCreate }">
                    <template x-if="progress.isCreating">
                        <div class="qbit-spinner w-4 h-4"></div>
                    </template>
                    <template x-if="!progress.isCreating">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </template>
                    <span x-text="progress.isCreating ? 'Creating...' : 'Create Torrent'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div x-show="progress.result" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="mt-6">
        <template x-if="progress.result && progress.result.success">
            <div class="qbit-alert qbit-alert-success">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <h4 class="font-medium">Torrent Created Successfully!</h4>
                        <p class="text-sm" x-text="progress.result.message"></p>
                    </div>
                </div>
            </div>
        </template>
        
        <template x-if="progress.error">
            <div class="qbit-alert qbit-alert-error">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <h4 class="font-medium">Creation Failed</h4>
                        <p class="text-sm" x-text="progress.error"></p>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>
{% endblock %}
