<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    
    <!-- Tailwind CSS (CDN for simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js (Lightweight reactive framework) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        .folder-item:hover { background-color: #f3f4f6; }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="torrentCreator()" x-cloak class="container mx-auto px-4 py-8">
        
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ğŸš€ Easy Torrent Creator</h1>
                    <p class="text-gray-600 mt-1">Create torrents easily with qBittorrent integration</p>
                </div>
                <div class="flex space-x-2">
                    <button @click="testConnection()" 
                            :disabled="isLoading"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg disabled:opacity-50">
                        ğŸ”— Test Connection
                    </button>
                    <a href="/config" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        âš™ï¸ Settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div x-show="connectionStatus" 
             :class="connectionSuccess ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'"
             class="border rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <span x-show="connectionSuccess" class="text-green-600">âœ…</span>
                <span x-show="!connectionSuccess" class="text-red-600">âŒ</span>
                <span x-text="connectionMessage" class="ml-2"></span>
            </div>
        </div>

        <!-- Docker Mapping Status -->
        <div x-show="dockerMapping && dockerMapping.enabled" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-blue-600">ğŸ³</span>
                    <span class="ml-2 font-medium text-blue-900">Docker Path Mapping Active</span>
                </div>
                <span class="text-sm text-blue-600" x-text="`${Object.keys(dockerMapping.mappings || {}).length} mapping(s)`"></span>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-2 gap-6">
            
            <!-- Left Column: Folder Selection -->
            <div class="space-y-6">
                
                <!-- Folder Browser -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-4">ğŸ“ Select Folder to Share</h2>
                    
                    <!-- Current Path -->
                    <div class="mb-4">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <span>ğŸ“‚</span>
                            <span x-text="currentPath"></span>
                        </div>
                    </div>
                    
                    <!-- Quick Access Buttons -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button @click="navigateToFolder(uploadRoot)" 
                                class="bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm border border-green-300">
                            ğŸš€ Upload Folder
                        </button>
                        <button @click="navigateToFolder('/mnt')" 
                                class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm">
                            ğŸ’¾ Mounts
                        </button>
                        <button @click="navigateToFolder('/tmp')" 
                                class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm">
                            ğŸ“‚ Tmp
                        </button>
                        <button @click="navigateToFolder('/mnt/user/data')" 
                                class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded text-sm border border-blue-300">
                            ğŸ³ Data
                        </button>
                    </div>
                    
                    <!-- Folder List -->
                    <div class="border rounded-lg max-h-64 overflow-y-auto">
                        <template x-for="item in folderItems" :key="item.path">
                            <div @click="handleItemClick(item)" 
                                 class="folder-item flex items-center p-3 border-b last:border-b-0 cursor-pointer">
                                <span x-show="item.type === 'parent'">â†©ï¸</span>
                                <span x-show="item.type === 'directory'">ğŸ“</span>
                                <span x-show="item.type === 'file'">ğŸ“„</span>
                                <span x-text="item.name" class="ml-2 flex-1"></span>
                                <span x-show="item.size" x-text="formatFileSize(item.size)" class="text-sm text-gray-500"></span>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Current Folder Actions -->
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium" x-text="currentPath"></div>
                                <div class="text-sm text-gray-600">Use current directory for torrent creation</div>
                            </div>
                            <button @click="selectCurrentFolder()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                âœ… Use This Folder
                            </button>
                        </div>
                    </div>
                    
                    <!-- Selected Folder Confirmation -->
                    <div x-show="selectedFolder && selectedFolder === currentPath" class="mt-2 p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="flex items-center text-green-700">
                            <span class="text-lg">âœ…</span>
                            <span class="ml-2 font-medium">Ready to create torrent from this folder</span>
                        </div>
                    </div>
                </div>
                
                <!-- Folder Information -->
                <div x-show="folderInfo" class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ“Š Folder Information</h3>
                    <div class="space-y-2">
                        <div><strong>Name:</strong> <span x-text="folderInfo?.name"></span></div>
                        <div><strong>Size:</strong> <span x-text="folderInfo?.size_formatted"></span></div>
                        <div><strong>Files:</strong> <span x-text="folderInfo?.file_count"></span> files in <span x-text="folderInfo?.folder_count"></span> folders</div>
                        <div><strong>Path:</strong> <span x-text="folderInfo?.path" class="text-sm break-all"></span></div>
                    </div>
                    
                    <!-- Validation Status -->
                    <div x-show="folderInfo?.is_valid" class="mt-3 p-2 bg-green-50 rounded text-green-700">
                        âœ… <span x-text="folderInfo?.validation_message"></span>
                    </div>
                    <div x-show="folderInfo && !folderInfo.is_valid" class="mt-3 p-2 bg-red-50 rounded text-red-700">
                        âŒ <span x-text="folderInfo?.validation_message"></span>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Torrent Options -->
            <div class="space-y-6">
                
                <!-- Torrent Options -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-4">âš™ï¸ Torrent Options</h2>
                    
                    <!-- Output Directory -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Save torrent file to:
                        </label>
                        <input x-model="outputDir" 
                               type="text" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="/path/to/output/directory">
                    </div>
                    
                    <!-- Options Checkboxes -->
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input x-model="private" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2">ğŸ”’ Private torrent</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input x-model="startSeeding" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2">ğŸŒ± Start seeding immediately</span>
                        </label>
                    </div>
                </div>
                
                <!-- Create Torrent Button -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <button @click="createTorrent()" 
                            :disabled="!canCreateTorrent()"
                            class="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg text-lg">
                        ğŸš€ Create Torrent
                    </button>
                    
                    <!-- Progress Bar -->
                    <div x-show="isCreating" class="mt-4">
                        <div class="bg-gray-200 rounded-full h-3">
                            <div class="progress-bar bg-green-500 h-3 rounded-full" :style="`width: ${progress}%`"></div>
                        </div>
                        <div class="text-sm text-gray-600 mt-2" x-text="statusMessage"></div>
                    </div>
                </div>
                
                <!-- Results -->
                <div x-show="result" class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ“‹ Results</h3>
                    
                    <div x-show="result?.success" class="space-y-2">
                        <div class="p-3 bg-green-50 rounded text-green-700">
                            âœ… Torrent created successfully!
                        </div>
                        <div x-show="result?.torrent_path">
                            <strong>File:</strong> <span x-text="result?.torrent_path" class="text-sm break-all"></span>
                        </div>
                        <div x-show="result?.torrent_hash">
                            <strong>Hash:</strong> <span x-text="result?.torrent_hash?.substring(0, 16) + '...'" class="text-sm font-mono"></span>
                        </div>
                    </div>
                    
                    <div x-show="result && !result.success" class="p-3 bg-red-50 rounded text-red-700">
                        âŒ <span x-text="result?.error"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function torrentCreator() {
            return {
                // State
                currentPath: '/',
                folderItems: [],
                selectedFolder: '',
                folderInfo: null,
                outputDir: './torrents',
                uploadRoot: '/mnt/user/data/downloads/torrents/qbittorrent/seedvault/',
                private: true,
                startSeeding: false,
                isLoading: false,
                isCreating: false,
                progress: 0,
                statusMessage: '',
                result: null,
                connectionStatus: null,
                connectionSuccess: false,
                connectionMessage: '',
                dockerMapping: null,  // Docker path mapping info
                showDockerInfo: false,  // Show/hide docker mapping details
                
                // Initialize
                async init() {
                    await this.loadConfig();
                    await this.loadDockerMapping();
                    await this.navigateToFolder('/');
                },
                
                // Load configuration
                async loadConfig() {
                    try {
                        const response = await fetch('/api/config');
                        const config = await response.json();
                        this.outputDir = config.default_output_dir || './torrents';
                        this.uploadRoot = config.default_upload_root || '/mnt/user/data/downloads/torrents/qbittorrent/seedvault/';
                        this.private = config.torrent_creation?.private ?? true;
                        this.startSeeding = config.torrent_creation?.start_seeding ?? false;
                    } catch (error) {
                        console.error('Failed to load config:', error);
                    }
                },
                
                // Load docker mapping information
                async loadDockerMapping() {
                    try {
                        const response = await fetch('/api/docker-mapping');
                        this.dockerMapping = await response.json();
                    } catch (error) {
                        console.error('Failed to load docker mapping:', error);
                        this.dockerMapping = { enabled: false, mappings: {} };
                    }
                },
                
                // Navigation
                async navigateToFolder(path) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/folders?path=${encodeURIComponent(path)}`);
                        const data = await response.json();
                        this.currentPath = data.current_path;
                        this.folderItems = data.items;
                        this.selectedFolder = '';
                        this.folderInfo = null;
                    } catch (error) {
                        console.error('Navigation failed:', error);
                    }
                    this.isLoading = false;
                },
                
                // Handle item clicks
                handleItemClick(item) {
                    if (item.type === 'directory' || item.type === 'parent') {
                        this.navigateToFolder(item.path);
                    } else {
                        // For files, show info but keep current directory context
                        console.log('File clicked:', item.name, item.path);
                        // Show a brief message that they can still use the current directory
                        this.showFileClickMessage(item.name);
                    }
                },
                
                // Show message when file is clicked
                showFileClickMessage(fileName) {
                    // This could show a toast or temporary message
                    console.log(`File "${fileName}" clicked. Use "âœ… Use This Folder" to create torrent from current directory.`);
                },
                
                // Select current folder
                selectCurrentFolder() {
                    console.log('Selecting folder - currentPath:', this.currentPath);
                    console.log('currentPath type check - exists:', !!this.currentPath);
                    
                    // Ensure we're using a directory path, not a file path
                    const folderPath = this.currentPath;
                    console.log('Using folder path:', folderPath);
                    
                    this.selectedFolder = folderPath;
                    this.getFolderInfo(folderPath);
                },
                
                // Get folder information
                async getFolderInfo(path) {
                    try {
                        console.log('Getting folder info for:', path);
                        const response = await fetch(`/api/folder-info?path=${encodeURIComponent(path)}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        console.log('Folder info received:', data);
                        this.folderInfo = data;
                    } catch (error) {
                        console.error('Failed to get folder info:', error);
                        this.folderInfo = null;
                        // Show user-friendly error
                        alert(`Failed to get folder information: ${error.message}`);
                    }
                },
                
                // Test connection
                async testConnection() {
                    this.isLoading = true;
                    this.connectionStatus = null;
                    
                    try {
                        const response = await fetch('/api/test-connection', { method: 'POST' });
                        const data = await response.json();
                        this.connectionSuccess = data.success;
                        this.connectionMessage = data.message;
                        this.connectionStatus = true;
                    } catch (error) {
                        this.connectionSuccess = false;
                        this.connectionMessage = `Connection failed: ${error.message}`;
                        this.connectionStatus = true;
                    }
                    
                    this.isLoading = false;
                    
                    // Hide status after 5 seconds
                    setTimeout(() => {
                        this.connectionStatus = null;
                    }, 5000);
                },
                
                // Create torrent
                async createTorrent() {
                    if (!this.canCreateTorrent()) return;
                    
                    this.isCreating = true;
                    this.progress = 0;
                    this.statusMessage = 'Preparing torrent creation...';
                    this.result = null;
                    
                    // Simulate progress
                    const progressInterval = setInterval(() => {
                        if (this.progress < 90) {
                            this.progress += Math.random() * 10;
                            if (this.progress < 30) {
                                this.statusMessage = 'Analyzing files...';
                            } else if (this.progress < 60) {
                                this.statusMessage = 'Creating torrent...';
                            } else {
                                this.statusMessage = 'Adding to qBittorrent...';
                            }
                        }
                    }, 500);
                    
                    try {
                        const response = await fetch('/api/create-torrent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                source_path: this.selectedFolder,
                                output_dir: this.outputDir,
                                private: this.private,
                                start_seeding: this.startSeeding
                            })
                        });
                        
                        this.result = await response.json();
                        this.progress = 100;
                        this.statusMessage = this.result.success ? 'Completed!' : 'Failed!';
                        
                    } catch (error) {
                        this.result = {
                            success: false,
                            error: `Request failed: ${error.message}`
                        };
                        this.statusMessage = 'Failed!';
                    }
                    
                    clearInterval(progressInterval);
                    this.isCreating = false;
                },
                
                // Validation
                canCreateTorrent() {
                    const result = this.selectedFolder && 
                           this.outputDir && 
                           this.folderInfo?.is_valid && 
                           !this.isCreating;
                    
                    // Debug logging
                    if (!result) {
                        console.log('Create torrent disabled. Conditions:', {
                            selectedFolder: !!this.selectedFolder,
                            outputDir: !!this.outputDir,
                            folderInfo: !!this.folderInfo,
                            folderInfoValid: this.folderInfo?.is_valid,
                            isCreating: this.isCreating
                        });
                    }
                    
                    return result;
                },
                
                // Utilities
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                }
            }
        }
    </script>
</body>
</html>
